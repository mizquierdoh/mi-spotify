"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[3191],{3191:(z,C,m)=>{m.d(C,{s:()=>U});var h=m(5861),l=m(529);class T{static parse(r){let e=new T;return e.id=r.id,e.name=r.name,e.type=r.type,e.volume=r.volume,e.isActive=r.is_active,e}}function d(p,r,e){return r in p?Object.defineProperty(p,r,{value:e,enumerable:!0,configurable:!0,writable:!0}):p[r]=e,p}let _;var p;(p=_||(_={})).Computer="Computer",p.Tablet="Tablet",p.Smartphone="Smartphone",p.Speaker="Speaker",p.TV="TV",p.AVR="AVR",p.STB="STB",p.AudioDongle="AudioDongle",p.GameConsole="GameConsole",p.CastVideo="CastVideo",p.CastAudio="CastAudio",p.Automobile="Automobile",p.Unknown="Unknown";const P={artists:[],duration:0,id:"",name:"",image:"",uri:""};class y{get token(){return this._token}get playing(){return this._playing}get ready(){return this._ready}get position(){return this._position}get track(){return this._track}get playlists(){return this._playlists}constructor(r,e=1){d(this,"_baseUrl","https://api.spotify.com/v1/me"),d(this,"_deviceId",""),d(this,"_token",""),d(this,"_playing",!1),d(this,"_ready",!1),d(this,"_position",0),d(this,"_track",P),d(this,"_playlists",[]),d(this,"_errorListeners",[]),d(this,"_stateListeners",[]),d(this,"_statusListeners",[]),d(this,"scopes",["playlist-read-collaborative","playlist-read-private","streaming","user-read-email","user-read-private","user-library-read","user-library-modify","user-read-playback-state","user-modify-playback-state"]),this._name=r,this._volume=e,this.handlePlayerStateChanges=this.handlePlayerStateChanges.bind(this),this.handlePlayerErrors=this.handlePlayerErrors.bind(this)}connect(r){var e=this;return(0,h.Z)(function*(){return e._token=r,yield Promise.all([e.waitForReady(),y.loadSpotifyPlayer()]),e._player=new window.Spotify.Player({name:e._name,volume:e._volume,getOAuthToken:o=>{o(r)}}),e.waitForConnection()})()}waitForConnection(){var r=this;if(!this._player)return Promise.resolve(!1);const e=this._player;this._player.addListener("player_state_changed",this.handlePlayerStateChanges),this._player.addListener("initialization_error",o=>{this.handlePlayerErrors("initialization_error",o)}),this._player.addListener("authentication_error",o=>{this.handlePlayerErrors("authentication_error",o)}),this._player.addListener("account_error",o=>{this.handlePlayerErrors("account_error",o)}),this._player.addListener("playback_error",o=>{this.handlePlayerErrors("playback_error",o)});const t=o=>{this._deviceId=o,this._ready=!0},s=()=>{this._ready=!1};return new Promise(o=>{e.addListener("ready",function(){var i=(0,h.Z)(function*({device_id:n}){t(n);for(const a of r._statusListeners)a("ready");o(!0)});return function(n){return i.apply(this,arguments)}}()),e.addListener("not_ready",()=>{s();for(const i of this._statusListeners)i("not_ready");o(!1)}),e.connect()})}static loadSpotifyPlayer(){return new Promise((r,e)=>{if(document.getElementById("spotify-player"))r();else{const s=document.createElement("script");s.id="spotify-player",s.type="text/javascript",s.async=!1,s.defer=!0,s.src="https://sdk.scdn.co/spotify-player.js",s.onload=()=>r(),s.onerror=()=>e(new Error("Error loading spotify-player.js")),document.head.appendChild(s)}})}waitForReady(){return new Promise(r=>{const e=()=>{r()};window.onSpotifyWebPlaybackSDKReady?e():window.onSpotifyWebPlaybackSDKReady=e})}play(r,e=0){var t=this;return(0,h.Z)(function*(){let s;if(Array.isArray(r)&&r.length)s=JSON.stringify({uris:r,offset:{position:e}});else if(r){const o=r.indexOf("artist")>=0,i=r.indexOf("track")>=0;let n;o||(n={position:e}),s=i?JSON.stringify({uris:[r],offset:n}):JSON.stringify({context_uri:r,offset:n})}yield fetch(`${t._baseUrl}/player/play?device_id=${t._deviceId}`,{method:"PUT",body:s,headers:{Authorization:`Bearer ${t._token}`,"Content-Type":"application/json"}})})()}pause(){var r=this;return(0,h.Z)(function*(){yield fetch(`${r._baseUrl}/player/pause`,{method:"PUT",headers:{Authorization:`Bearer ${r._token}`,"Content-Type":"application/json"}})})()}previous(){var r=this;return(0,h.Z)(function*(){yield fetch(`${r._baseUrl}/player/previous`,{method:"POST",headers:{Authorization:`Bearer ${r._token}`,"Content-Type":"application/json"}})})()}next(){var r=this;return(0,h.Z)(function*(){yield fetch(`${r._baseUrl}/player/next`,{method:"POST",headers:{Authorization:`Bearer ${r._token}`,"Content-Type":"application/json"}})})()}seek(r){var e=this;return(0,h.Z)(function*(){yield fetch(`${e._baseUrl}/player/seek?position_ms=${r}`,{method:"PUT",headers:{Authorization:`Bearer ${e._token}`,"Content-Type":"application/json"}})})()}getPlaybackState(){var r=this;return(0,h.Z)(function*(){const e=yield fetch(`${r._baseUrl}/player`,{method:"GET",headers:{Authorization:`Bearer ${r._token}`,"Content-Type":"application/json"}});return 204===e.status?null:e.json()})()}getPlaylists(){var r=this;return(0,h.Z)(function*(){let e=`${r._baseUrl}/playlists?limit=50`,t=[];for(;;){const o=yield(yield fetch(e,{headers:{Authorization:`Bearer ${r._token}`}})).json();if(t=t.concat(o.items),null===o.next)break;e=o.next}return Promise.all(t.map(function(){var s=(0,h.Z)(function*(o){let i=`${o.tracks.href}?limit=100`,n=[];for(;;){const u=yield(yield fetch(i,{headers:{Authorization:`Bearer ${r._token}`}})).json();if(n=n.concat(u.items),null===u.next)break;i=u.next}return{id:o.id,images:o.images,name:o.name,tracks:n}});return function(o){return s.apply(this,arguments)}}()))})()}getFavorites(){var r=this;return(0,h.Z)(function*(){return{name:"Your Music",tracks:(yield(yield fetch(`${r._baseUrl}/tracks?limit=50`,{headers:{Authorization:`Bearer ${r._token}`}})).json()).items}})()}getUsersPlaylists(){var r=this;return(0,h.Z)(function*(){let[e,t]=yield Promise.all([r.getPlaylists(),r.getFavorites()]);return e=[t,...e],e=e.map(s=>({name:s.name,tracks:s.tracks.map(({track:o})=>({artists:o.artists.map(({id:i,name:n})=>({id:i,name:n})),duration:o.duration_ms,id:o.id,image:o.album.images.find(()=>!0),name:o.name,uri:o.uri}))})),e})()}setToken(r){this._token=r}setVolume(r){var e=this;return(0,h.Z)(function*(){const t=`${e._baseUrl}/player/volume?volume_percent=${r}`;yield fetch(t,{method:"PUT",headers:{Authorization:`Bearer ${e._token}`,"Content-Type":"application/json"}})})()}addListener(r,e){switch(r){case"error":this._errorListeners.push(e);break;case"state":this._stateListeners.push(e);break;case"ready":this._statusListeners.push(e)}}removeListener(r,e){const t=s=>!!e&&s!==e;switch(r){case"error":this._errorListeners=this._errorListeners.filter(t);break;case"state":this._stateListeners=this._stateListeners.filter(t);break;case"ready":this._statusListeners=this._statusListeners.filter(t)}}getAlbumImage(r){const e=Math.min(...r.images.map(s=>s.width));return(r.images.find(s=>s.width===e)||{}).url}handlePlayerStateChanges(r){var e=this;return(0,h.Z)(function*(){if(!r){e._track=P,e._position=0,e._playing=!1;for(const f of e._stateListeners)f(r);return}const{paused:t,position:s,track_window:{current_track:{album:o,artists:i,duration_ms:n,id:a,name:c,uri:u}}}=r;e._playing=!t,e._position=s,e._track={artists:i.map(({name:f})=>f),duration:n,image:e.getAlbumImage(o),id:a,name:c,uri:u};for(const f of e._stateListeners)f(r)})()}handlePlayerErrors(r,e){this._ready=!1,this._player&&"playback_error"!==r&&(this._player.removeListener("player_state_changed"),this._player.removeListener("initialization_error"),this._player.removeListener("authentication_error"),this._player.removeListener("account_error"),this._player.disconnect());for(const t of this._errorListeners)t(r)}}class k extends y{constructor(){super(...arguments),this.shuffleTrack=!1,this.shuffleAlbum=!0}get volume(){return this.myVolume}set volume(r){this.volume=r,super.setVolume(r)}}class j{static parse(r){if(!r)return null;let e=new j;return e.access_token=r.access_token,e.expires=new Date(r.expires),e.refresh_token=r.refresh_token,e}}var $=m(6738),B=m(1188),L=m(1543);const S="0ef858dc874e495a891f9ae9a1f01bf5";let U=(()=>{class p{constructor(e,t,s){this.http=e,this.storageService=t,this.router=s,console.log("location.origin",location.origin),console.log("location.href",location.href),console.log("location.pathname",location.pathname)}initPlayer(){var e=this;return(0,h.Z)(function*(){e.player||(e.player=new k("Leftidos"),e.getToken().then(t=>{e.player.connect(t.access_token)})),console.log(e.player)})()}get autorizado(){return!(!this.token||this.token.expires.getTime()<(new Date).getTime())}generateRandomString(e){for(var t="",s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",o=0;o<e;o++)t+=s.charAt(Math.floor(Math.random()*s.length));return t}loginUrl(){var t=this.generateRandomString(16);return`https://accounts.spotify.com/authorize?client_id=${S}&redirect_uri=${this.redirectUri}&response_type=code&scope=user-follow-read user-read-currently-playing playlist-read-collaborative playlist-read-private streaming user-read-email user-read-private user-library-read user-library-modify user-read-playback-state user-modify-playback-state&state=${t}`}getCurrentlyPlaying(){return new Promise(e=>{this.getToken().then(t=>{const o=new l.WM({"Content-Type":"application/json",Authorization:`Bearer ${t.access_token}`});e(this.http.get("https://api.spotify.com/v1/me/player/currently-playing",{headers:o}))})})}getPlaybackState(){return new Promise(e=>{this.getToken().then(t=>{const o=new l.WM({"Content-Type":"application/json",Authorization:`Bearer ${t.access_token}`});e(this.http.get("https://api.spotify.com/v1/me/player",{headers:o}))})})}getRecentlyPlayed(){return new Promise(e=>{this.getToken().then(t=>{const o=new l.WM({"Content-Type":"application/json",Authorization:`Bearer ${t.access_token}`});e(this.http.get("https://api.spotify.com/v1/me/player/recently-played",{headers:o}))})})}getAvaiableDevices(){return new Promise(e=>{this.getToken().then(t=>{const o=new l.WM({"Content-Type":"application/json",Authorization:`Bearer ${t.access_token}`});this.http.get("https://api.spotify.com/v1/me/player/devices",{headers:o}).subscribe(n=>{console.log("Devices: ",n),this.devices=n.devices.map(a=>T.parse(a)),e()})})})}getToken(){var e=this;return(0,h.Z)(function*(){if(console.log("01-Inicio",e.token),!e.token){console.log("02-no hay token guardado, se busca del storage");let t=!1;for(;!t;)try{e.token=j.parse(yield e.storageService.get("spotify_token")),t=!0,console.log("03-Token encontrado en storage",e.token)}catch{t=!1}}if(e.token){if(console.log("04-Ya tenemos token",e.token),(new Date).getTime()<e.token.expires.getTime())return console.log("06-El token no ha expirado, perfecto",e.token),new Promise(t=>{t(e.token)});console.log("07-El token ha expirado, intentamos refrescarlo",e.token);try{return e.setToken(e.token.refresh_token)}catch{e.router.navigateByUrl("/login"),Promise.reject()}}else console.log("05-Ni con esas hay token, volvemos a login"),e.router.navigateByUrl("/login"),Promise.reject()})()}setToken(e){this.redirectUri||(console.log("08-No hay redirecci\xf3n, volvemos a login"),this.router.navigateByUrl("/login")),console.log("09-Hay redirecci\xf3n",this.redirectUri);const s=`code=${e}&redirect_uri=${this.redirectUri}&grant_type=authorization_code`;return console.log("10-Refrescamos el token",s),new Promise((o,i)=>{this.http.post("https://accounts.spotify.com/api/token",s,{headers:new l.WM({Authorization:"Basic  "+btoa(S+":547a96667ac94ba3992d07f7df66686e"),"Content-Type":"application/x-www-form-urlencoded;"})}).subscribe(n=>{console.log("11-Obtenemos la respuesta",n);let a=new Date;a.setTime(a.getTime()+1e3*n.expires_in),this.token={access_token:n.access_token,expires:a,refresh_token:n.refresh_token},this.storageService.set("spotify_token",this.token),this.initPlayer(),o(this.token)},n=>{console.log("12-Ha fallado el refresco",n),this.router.navigateByUrl("/login")})})}playTrack(e,t){return new Promise(s=>{this.getToken().then(o=>{const n=new l.WM({Accept:"application/json","Content-Type":"application/json",Authorization:`Bearer ${o.access_token}`});let a={};e&&(a.uris=[e]);const c="https://api.spotify.com/v1/me/player/play".concat(t?`?device_id=${t}`:"");return this.http.put(c,a,{headers:n}).subscribe(u=>{s()},u=>console.error(u))})})}play(e,t){return new Promise(s=>{this.getToken().then(o=>{const n=new l.WM({Accept:"application/json","Content-Type":"application/json",Authorization:`Bearer ${o.access_token}`});let a={};e&&(a.context_uri=e);const c="https://api.spotify.com/v1/me/player/play".concat(t?`?device_id=${t}`:"");return this.http.put(c,a,{headers:n}).subscribe(u=>{s()},u=>console.error(u))})})}setRepeatMode(e,t){return new Promise(s=>{this.getToken().then(o=>{const n=new l.WM({Accept:"application/json","Content-Type":"application/json",Authorization:`Bearer ${o.access_token}`});return this.http.put(`https://api.spotify.com/v1/me/player/repeat?state=${e}`+!!t?`&device_id=${t}`:"",{headers:n}).subscribe(c=>{s()},c=>console.error(c))})})}seekToPosition(e,t){return new Promise(s=>{this.getToken().then(o=>{const n=new l.WM({Accept:"application/json","Content-Type":"application/json",Authorization:`Bearer ${o.access_token}`}),a=`https://api.spotify.com/v1/me/player/seek?position_ms=${e}`.concat(t?`&device_id=${t}`:"");return this.http.put(a,null,{headers:n}).subscribe(c=>{s()},c=>console.error(c))})})}transferPlayback(e){return new Promise(t=>{this.getToken().then(s=>{const i=new l.WM({Accept:"application/json","Content-Type":"application/json",Authorization:`Bearer ${s.access_token}`});return this.http.put(`https://api.spotify.com/v1/me/player?device_id=${e}`,JSON.stringify({device_ids:[e]}),{headers:i}).subscribe(c=>{t()},c=>console.error(c))})})}pause(e){return new Promise(t=>{this.getToken().then(s=>{const i=new l.WM({Accept:"application/json","Content-Type":"application/json",Authorization:`Bearer ${s.access_token}`});let n="https://api.spotify.com/v1/me/player/pause".concat(e?`?device_id=${e}`:"");return this.http.put(n,null,{headers:i}).subscribe(a=>{t()},a=>console.error(a))})})}togglePlaybackShuffle(e,t){return new Promise(s=>{this.getToken().then(o=>{const n=new l.WM({Accept:"application/json","Content-Type":"application/json",Authorization:`Bearer ${o.access_token}`});let a=`https://api.spotify.com/v1/me/player/shuffle?state=${e}`.concat(t?`&device_id=${t}`:"");return this.http.put(a,null,{headers:n}).subscribe(c=>{s()},c=>console.error(c))})})}next(e){return new Promise(t=>{this.getToken().then(s=>{const i=new l.WM({Accept:"application/json","Content-Type":"application/json",Authorization:`Bearer ${s.access_token}`});return this.http.post(`https://api.spotify.com/v1/me/player/next?device_id=${e}`,{headers:i}).subscribe(a=>{t()},a=>console.error(a))})})}previous(e){return new Promise(t=>{this.getToken().then(s=>{const i=new l.WM({Accept:"application/json","Content-Type":"application/json",Authorization:`Bearer ${s.access_token}`});return this.http.post(`https://api.spotify.com/v1/me/player/previous?device_id=${e}`,{headers:i}).subscribe(a=>{t()},a=>console.error(a))})})}addItemToPlaybackQueue(e,t){return new Promise(s=>{this.getToken().then(o=>{const n=new l.WM({Accept:"application/json","Content-Type":"application/json",Authorization:`Bearer ${o.access_token}`});return this.http.post(`https://api.spotify.com/v1/me/player/queue?uri=${e}`+!!t?`&device_id=${t}`:"",JSON.stringify({context_uri:e}),{headers:n}).subscribe(u=>{s()},u=>console.error(u))})})}searchGrupo(e,t){return new Promise(s=>{this.getToken().then(o=>{const i=o.access_token,n=window.encodeURIComponent(e),a=new l.WM({"Content-Type":"application/json",Authorization:`Bearer ${i}`});return this.http.get(`https://api.spotify.com/v1/search?q=${n}&type=artist&offset=${t}&market=ES`,{headers:a}).subscribe(u=>{const f=u.artists,b=f.items.sort((g,v)=>Number.parseInt(g.popularity)-Number.parseInt(v.popularity));for(const g of b){let A,v=0;for(const w of g.images)Number.parseInt(w.height)>v&&(v=Number.parseInt(w.height),A=w.url)}s({total:f.total})})})})}getGrupos(e){return new Promise(t=>{this.getToken().then(s=>{const i=new l.WM({"Content-Type":"application/json",Authorization:`Bearer ${s.access_token}`});let n="";for(let c=0;c<e.length;c++)!e[c].infoSpotify.idSpotify||(n+=e[c].infoSpotify.idSpotify,e.length-1!=c&&(n+=","));return this.http.get("https://api.spotify.com/v1/artists?ids="+n,{headers:i}).subscribe(c=>{let u=[];const f=c.artists;for(const b of f){let g;if(g.nombre=b.name,g.idSpotify=b.id,g.generos=b.genres,b.images){let A,v=0;for(const w of b.images)Number.parseInt(w.height)>v&&(v=Number.parseInt(w.height),A=w.url);g.image=A}u.push(g)}t(u)})})})}getTopTracks(e){return new Promise(t=>{this.getToken().then(s=>{const i=new l.WM({"Content-Type":"application/json",Authorization:`Bearer ${s.access_token}`});this.http.get(`https://api.spotify.com/v1/artists/${e}/top-tracks?market=ES`,{headers:i}).subscribe(a=>{t(a.tracks.map(c=>c.preview_url))})})})}getUserProfile(){return new Promise((e,t)=>{this.getToken().then(s=>{const o=new l.WM({"Content-Type":"application/json",Authorization:`Bearer ${s.access_token}`});this.http.get("https://api.spotify.com/v1/me",{headers:o}).subscribe(i=>{e(i)},i=>t(i))})})}getFollowedArtists(e){return new Promise((t,s)=>{this.getToken().then(o=>{const i=new l.WM({"Content-Type":"application/json",Authorization:`Bearer ${o.access_token}`});let n="https://api.spotify.com/v1/me/following?type=artist&limit=50";e&&(n=n.concat("&after="+e)),this.http.get(n,{headers:i}).subscribe(a=>{t(a)},a=>s(a))})})}getArtistsAlbums(e,t){return new Promise((s,o)=>{this.getToken().then(i=>{const n=new l.WM({"Content-Type":"application/json",Authorization:`Bearer ${i.access_token}`});this.http.get(`https://api.spotify.com/v1/artists/${e}/albums?include_groups=album&market=ES&limit=50&offset=${t}`,{headers:n}).subscribe(c=>{s(c)},c=>o(c))})})}getAlbumsTracks(e,t){return new Promise((s,o)=>{this.getToken().then(i=>{const n=new l.WM({"Content-Type":"application/json",Authorization:`Bearer ${i.access_token}`});this.http.get(`https://api.spotify.com/v1/albums/${e}/tracks?market=ES&limit=50&&offset=${t}`,{headers:n}).subscribe(c=>{s(c)},c=>o(c))})})}}return p.\u0275fac=function(e){return new(e||p)($.LFG(l.eN),$.LFG(B.V),$.LFG(L.F0))},p.\u0275prov=$.Yz7({token:p,factory:p.\u0275fac,providedIn:"root"}),p})()},1188:(z,C,m)=>{m.d(C,{V:()=>d});var h=m(5861),l=m(6738),T=m(849);let d=(()=>{class _{constructor(y){this.storage=y,this._storage=null,this.init()}init(){var y=this;return(0,h.Z)(function*(){const k=yield y.storage.create();y._storage=k})()}set(y,k){this._storage?.set(y,k)}get(y){var k=this;return(0,h.Z)(function*(){if(!k._storage)throw"Storage not ready";return yield k._storage?.get(y)})()}}return _.\u0275fac=function(y){return new(y||_)(l.LFG(T.K))},_.\u0275prov=l.Yz7({token:_,factory:_.\u0275fac,providedIn:"root"}),_})()}}]);